<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Admin Panel - ShopLux E-Commerce Management">
    <meta name="keywords" content="admin, dashboard, management, products, orders">
    <meta name="theme-color" content="#1a1a2e">
    <meta property="og:title" content="Admin Panel - ShopLux">
    <meta property="og:type" content="website">
    <title>Admin Panel - ShopLux</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ’Ž</text></svg>">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
</head>
<body>
    <div class="loading-overlay hidden" id="loadingOverlay">
        <div class="loader"></div>
    </div>

    <!-- Premium Apple-Style Navbar -->
    <nav class="navbar" id="navbar">
        <div class="nav-wrapper">
            <div class="nav-logo" onclick="window.location.href='index.html'">
                <div class="nav-logo-icon"><i class="fas fa-gem"></i></div>
                <span class="nav-logo-text">ShopLux</span>
            </div>
            
            <div class="nav-search-wrapper">
                <div class="nav-search">
                    <i class="fas fa-search nav-search-icon"></i>
                    <input type="text" class="nav-search-input" placeholder="Search products..." id="searchInput" onkeypress="if(event.key==='Enter')performSearch()">
                    <button class="nav-search-btn" onclick="performSearch()"><i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            
            <div class="nav-actions">
                <a href="index.html" class="nav-icon-btn">
                    <i class="fas fa-home"></i>
                </a>
                
                <div class="nav-user-wrapper" id="userWrapper" style="display: none;">
                    <div class="nav-user-btn">
                        <div class="nav-user-avatar" id="userAvatar">U</div>
                        <span class="nav-user-name" id="userNameDisplay"></span>
                    </div>
                    <div class="nav-user-dropdown">
                        <div class="nav-dropdown-item" id="userDropdownName"></div>
                        <div class="nav-dropdown-divider"></div>
                        <div class="nav-dropdown-item" onclick="logout()"><i class="fas fa-sign-out-alt"></i><span>Logout</span></div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <aside class="admin-sidebar">
            <h3>Admin Panel</h3>
            <ul class="admin-menu">
                <li class="active" onclick="showAdminSection('products')">
                    <i class="fas fa-box"></i> Products
                </li>
                <li onclick="showAdminSection('orders')">
                    <i class="fas fa-shopping-cart"></i> Orders
                </li>
                <li onclick="showAdminSection('add-product')">
                    <i class="fas fa-plus"></i> Add Product
                </li>
            </ul>
        </aside>
        
        <main class="admin-content">
            <div class="admin-header">
                <h2 id="adminTitle">Products Management</h2>
                <button class="btn-primary" onclick="showAdminSection('add-product')">
                    <i class="fas fa-plus"></i> Add New Product
                </button>
            </div>
            
            <div class="admin-section" id="productsSection">
                <div class="admin-filters">
                    <input type="text" placeholder="Search products..." id="adminSearch" onkeyup="filterProducts()">
                    <select id="categoryFilter" onchange="filterProducts()">
                        <option value="">All Categories</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Accessories">Accessories</option>
                        <option value="Sportswear">Sportswear</option>
                    </select>
                </div>
                
                <div class="admin-table-container">
                    <table class="admin-table" id="productsTable">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Image</th>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTableBody">
                            <!-- Products loaded dynamically -->
                        </tbody>
                    </table>
                </div>
                
                <div class="pagination" id="adminPagination">
                    <!-- Pagination loaded dynamically -->
                </div>
            </div>
            
            <div class="admin-section" id="ordersSection" style="display: none;">
                <div class="admin-table-container">
                    <table class="admin-table">
                        <thead>
                            <tr>
                                <th>Order ID</th>
                                <th>Customer</th>
                                <th>Date</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTableBody">
                            <!-- Orders loaded dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div class="admin-section" id="addProductSection" style="display: none;">
                <div class="product-form-container">
                    <form id="productForm" onsubmit="handleProductSubmit(event)">
                        <input type="hidden" id="editProductId">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productName">Product Name</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-box"></i>
                                    <input type="text" id="productName" placeholder="Product name" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="productBrand">Brand</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-tag"></i>
                                    <input type="text" id="productBrand" placeholder="Brand name" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productDescription">Description</label>
                            <div class="input-wrapper">
                                <i class="fas fa-align-left"></i>
                                <textarea id="productDescription" placeholder="Product description" rows="4"></textarea>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productPrice">Price ($)</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-dollar-sign"></i>
                                    <input type="number" id="productPrice" placeholder="0.00" step="0.01" min="0" required>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label for="productDiscount">Discount Price ($)</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-percent"></i>
                                    <input type="number" id="productDiscount" placeholder="0.00" step="0.01" min="0">
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="productCategory">Category</label>
                                <select id="productCategory" required>
                                    <option value="">Select Category</option>
                                    <option value="Electronics">Electronics</option>
                                    <option value="Clothing">Clothing</option>
                                    <option value="Accessories">Accessories</option>
                                    <option value="Sportswear">Sportswear</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label for="productStock">Stock Quantity</label>
                                <div class="input-wrapper">
                                    <i class="fas fa-boxes"></i>
                                    <input type="number" id="productStock" placeholder="0" min="0" required>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="productImage">Image URL</label>
                            <div class="input-wrapper">
                                <i class="fas fa-image"></i>
                                <input type="url" id="productImage" placeholder="https://..." required>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="productFeatured">
                                <span>Mark as Featured</span>
                            </label>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="btn-primary">
                                <i class="fas fa-save"></i> Save Product
                            </button>
                            <button type="button" class="btn-secondary" onclick="resetProductForm()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <div class="modal" id="productModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Product</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Edit form -->
            </div>
        </div>
    </div>

    <div class="toast-container" id="toastContainer"></div>

    <script src="js/loader.js"></script>
    <script src="js/api.js"></script>
    <script src="js/main.js"></script>
    <script>
        function hideLoading() { LoadingManager.hide(); }
        function showLoading() { LoadingManager.show(); }
        
        let currentPage = 0;
        
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadAdminProducts();
            loadAdminOrders();
        });
        
        function showAdminSection(section) {
            document.querySelectorAll('.admin-section').forEach(s => s.style.display = 'none');
            document.querySelectorAll('.admin-menu li').forEach(l => l.classList.remove('active'));
            
            if (section === 'products') {
                document.getElementById('productsSection').style.display = 'block';
                document.querySelectorAll('.admin-menu li')[0].classList.add('active');
                document.getElementById('adminTitle').textContent = 'Products Management';
            } else if (section === 'orders') {
                document.getElementById('ordersSection').style.display = 'block';
                document.querySelectorAll('.admin-menu li')[1].classList.add('active');
                document.getElementById('adminTitle').textContent = 'Orders Management';
            } else if (section === 'add-product') {
                document.getElementById('addProductSection').style.display = 'block';
                document.querySelectorAll('.admin-menu li')[2].classList.add('active');
                document.getElementById('adminTitle').textContent = 'Add New Product';
            }
        }
        
        function loadAdminProducts(page = 0) {
            currentPage = page;
            
            fetchAPI(`/api/products?page=${page}&size=10&sortBy=id&desc`, 'GET')
                .then(data => {
                    displayAdminProducts(data);
                })
                .catch(error => {
                    console.error('Error loading products:', error);
                    showToast('Error loading products', 'error');
                });
        }
        
        function displayAdminProducts(data) {
            const tbody = document.getElementById('productsTableBody');
            
            if (!data.content || data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7">No products found</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.content.map(product => `
                <tr>
                    <td>${product.id}</td>
                    <td><img src="${product.imageUrl}" alt="${product.name}" class="table-image"></td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>$${product.discountPrice ? product.discountPrice.toFixed(2) : product.price.toFixed(2)}</td>
                    <td>${product.stockQuantity}</td>
                    <td>
                        <button class="action-btn edit" onclick="editProduct(${product.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="action-btn delete" onclick="deleteProduct(${product.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
            
            displayAdminPagination(data);
        }
        
        function displayAdminPagination(data) {
            const pagination = document.getElementById('adminPagination');
            
            if (data.totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let html = '';
            
            if (data.number > 0) {
                html += `<button onclick="loadAdminProducts(${data.number - 1})" class="page-btn">Prev</button>`;
            }
            
            for (let i = 0; i < data.totalPages; i++) {
                if (i === data.number) {
                    html += `<button class="page-btn active">${i + 1}</button>`;
                } else {
                    html += `<button onclick="loadAdminProducts(${i})" class="page-btn">${i + 1}</button>`;
                }
            }
            
            if (data.number < data.totalPages - 1) {
                html += `<button onclick="loadAdminProducts(${data.number + 1})" class="page-btn">Next</button>`;
            }
            
            pagination.innerHTML = html;
        }
        
        function filterProducts() {
            loadAdminProducts(0);
        }
        
        function editProduct(productId) {
            fetchAPI(`/api/products/${productId}`, 'GET')
                .then(product => {
                    document.getElementById('editProductId').value = product.id;
                    document.getElementById('productName').value = product.name;
                    document.getElementById('productBrand').value = product.brand || '';
                    document.getElementById('productDescription').value = product.description || '';
                    document.getElementById('productPrice').value = product.price;
                    document.getElementById('productDiscount').value = product.discountPrice || '';
                    document.getElementById('productCategory').value = product.category;
                    document.getElementById('productStock').value = product.stockQuantity;
                    document.getElementById('productImage').value = product.imageUrl;
                    document.getElementById('productFeatured').checked = product.isFeatured;
                    
                    showAdminSection('add-product');
                    document.getElementById('adminTitle').textContent = 'Edit Product';
                    showToast('Editing product: ' + product.name, 'success');
                })
                .catch(error => {
                    console.error('Error loading product:', error);
                    showToast('Error loading product', 'error');
                });
        }
        
        function deleteProduct(productId) {
            if (!confirm('Are you sure you want to delete this product?')) {
                return;
            }
            
            fetchAPI(`/api/products/${productId}`, 'DELETE')
                .then(() => {
                    showToast('Product deleted successfully', 'success');
                    loadAdminProducts(currentPage);
                })
                .catch(error => {
                    console.error('Error deleting product:', error);
                    showToast('Error deleting product', 'error');
                });
        }
        
        function handleProductSubmit(event) {
            event.preventDefault();
            
            const productId = document.getElementById('editProductId').value;
            
            const productData = {
                name: document.getElementById('productName').value,
                brand: document.getElementById('productBrand').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                discountPrice: parseFloat(document.getElementById('productDiscount').value) || null,
                category: document.getElementById('productCategory').value,
                stockQuantity: parseInt(document.getElementById('productStock').value),
                imageUrl: document.getElementById('productImage').value,
                isFeatured: document.getElementById('productFeatured').checked
            };
            
            const method = productId ? 'PUT' : 'POST';
            const url = productId ? `/api/products/${productId}` : '/api/products';
            
            showLoading();
            
            fetchAPI(url, method, productData)
                .then(() => {
                    showToast(productId ? 'Product updated successfully' : 'Product created successfully', 'success');
                    resetProductForm();
                    loadAdminProducts();
                    showAdminSection('products');
                })
                .catch(error => {
                    console.error('Error saving product:', error);
                    showToast('Error saving product', 'error');
                })
                .finally(() => hideLoading());
        }
        
        function resetProductForm() {
            document.getElementById('productForm').reset();
            document.getElementById('editProductId').value = '';
            document.getElementById('adminTitle').textContent = 'Add New Product';
        }
        
        function loadAdminOrders() {
            fetchAPI('/api/orders/all?page=0&size=50', 'GET')
                .then(data => {
                    displayAdminOrders(data);
                })
                .catch(error => {
                    console.error('Error loading orders:', error);
                });
        }
        
        function displayAdminOrders(data) {
            const tbody = document.getElementById('ordersTableBody');
            
            if (!data.content || data.content.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6">No orders found</td></tr>';
                return;
            }
            
            tbody.innerHTML = data.content.map(order => `
                <tr>
                    <td>#${order.id}</td>
                    <td>${order.items ? order.items.length + ' items' : 'N/A'}</td>
                    <td>${order.createdAt ? order.createdAt.split('T')[0] : 'N/A'}</td>
                    <td>$${order.totalAmount.toFixed(2)}</td>
                    <td><span class="status-badge ${order.status.toLowerCase()}">${order.status}</span></td>
                    <td>
                        <button class="action-btn view" onclick="viewOrder(${order.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        function viewOrder(orderId) {
            fetchAPI(`/api/orders/${orderId}`, 'GET')
                .then(order => {
                    alert(`Order #${order.id}\nStatus: ${order.status}\nTotal: $${order.totalAmount}\nItems: ${order.items ? order.items.length : 0}`);
                })
                .catch(error => {
                    console.error('Error loading order:', error);
                    showToast('Error loading order', 'error');
                });
        }
    </script>
</body>
</html>
